<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVE Orders Dashboard</title>
  <style>
    :root {
      --bg:      #070710;
      --bg2:     #0e0e1c;
      --bg3:     #141428;
      --border:  #232340;
      --text:    #c0c8d8;
      --text2:   #68707e;
      --gold:    #c6a227;
      --blue:    #4a9eed;
      --green:   #3dba6e;
      --red:     #d14040;
      --orange:  #e08820;
      --purple:  #9b6fd4;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ── Header ── */
    header {
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-size: 18px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; user-select: none; }
    .logo .eve    { color: var(--gold); }
    .logo .orders { color: var(--blue); }
    .char-info { display: flex; align-items: center; gap: 10px; }
    .char-info img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border); }
    .char-name { font-weight: 600; }

    /* ── Buttons ── */
    button { cursor: pointer; font-family: inherit; font-size: 14px; border-radius: 4px; border: none; transition: all 0.15s; }
    .btn         { padding: 8px 16px; font-weight: 600; }
    .btn-primary { background: var(--gold); color: #000; }
    .btn-primary:hover    { background: #d4b030; }
    .btn-primary:disabled { opacity: 0.5; cursor: default; }
    .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover    { border-color: var(--text2); background: var(--bg3); }
    .btn-secondary:disabled { opacity: 0.4; cursor: default; }

    /* ── Login view ── */
    #login-view {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 52px);
      padding: 40px 16px;
    }
    .login-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 40px;
      max-width: 460px;
      width: 100%;
    }
    .login-card h2 { font-size: 22px; color: var(--gold); margin-bottom: 10px; }
    .login-card > p { color: var(--text2); margin-bottom: 24px; line-height: 1.65; }
#login-error { color: var(--red); font-size: 13px; margin-bottom: 12px; display: none; }

    /* ── Dashboard ── */
    #dashboard-view { padding: 20px; max-width: 1500px; margin: 0 auto; }

    /* ── Stats bar ── */
    .stats-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 14px 20px;
      flex: 1;
      min-width: 130px;
    }
    .stat-card.stat-wide { min-width: 200px; flex: 2; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text2); margin-bottom: 4px; }
    .stat-value { font-size: 20px; font-weight: 700; }
    .stat-sub   { font-size: 12px; color: var(--text2); margin-top: 2px; }
    .stat-value.gold   { color: var(--gold); }
    .stat-value.green  { color: var(--green); }
    .stat-value.blue   { color: var(--blue); }
    .stat-value.purple { color: var(--purple); }
    .stat-value.red    { color: var(--red); }
    .slot-bar { margin-top: 8px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .slot-fill { height: 100%; border-radius: 2px; background: var(--green); transition: width .3s; }
    .slot-fill.warn { background: var(--orange); }
    .slot-fill.crit { background: var(--red); }

    /* ── Station breakdown ── */
    .section {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }
    .section-header:hover { background: #1a1a30; }
    .section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text2); }
    .section-toggle { font-size: 11px; color: var(--text2); }

    .station-table { width: 100%; border-collapse: collapse; }
    .station-table th {
      padding: 8px 14px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text2);
      white-space: nowrap;
    }
    .station-table th.r { text-align: right; }
    .station-table td { padding: 8px 14px; border-top: 1px solid var(--border); white-space: nowrap; }
    .station-table td.r { text-align: right; }
    .station-table tr:hover td { background: var(--bg3); }
    .st-name { font-weight: 500; color: var(--text); }
    .st-sell { color: var(--green); font-variant-numeric: tabular-nums; }
    .st-buy  { color: var(--blue);  font-variant-numeric: tabular-nums; }

    /* ── Toolbar ── */
    .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .toolbar-title { font-size: 15px; font-weight: 600; flex: 1; }
    .filter-group { display: flex; gap: 4px; align-items: center; }
    .filter-sep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }

    .filter-group select {
      background: var(--bg2); border: 1px solid var(--border); color: var(--text);
      border-radius: 4px; padding: 5px 8px; font-size: 12px; cursor: pointer;
      font-family: inherit;
    }
    .filter-group select:hover { border-color: var(--text2); }

    .ticks-input {
      background: var(--bg2); border: 1px solid var(--border); color: var(--text);
      border-radius: 4px; padding: 4px 6px; font-size: 12px; width: 52px;
      text-align: center; font-family: inherit;
    }
    .ticks-input:hover { border-color: var(--text2); }

    .copy-col { width: 32px; text-align: center; padding: 0 4px; }

    .filter-btn {
      padding: 5px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: transparent;
      color: var(--text2);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .filter-btn:hover           { background: var(--bg3); color: var(--text); border-color: var(--text2); }
    .filter-btn.f-active        { background: var(--bg3); color: var(--text); border-color: var(--text2); }
    .filter-btn.f-active-sell   { background: rgba(61,186,110,.15); color: var(--green);  border-color: var(--green); }
    .filter-btn.f-active-buy    { background: rgba(74,158,237,.15); color: var(--blue);   border-color: var(--blue); }
    .filter-btn.f-active-corp   { background: rgba(155,111,212,.15); color: var(--purple); border-color: var(--purple); }
    .filter-btn.f-active-personal { background: rgba(198,162,39,.12); color: var(--gold); border-color: var(--gold); }
    .filter-btn.f-active-undercut { background: rgba(209,64,64,.15); color: var(--red);   border-color: var(--red); }
    .filter-btn.f-active-best   { background: rgba(61,186,110,.15); color: var(--green);  border-color: var(--green); }

    /* ── Button groups ── */
    .btn-group { display: flex; }
    .btn-group .filter-btn { border-radius: 0; border-right-width: 0; }
    .btn-group .filter-btn:first-child { border-radius: 4px 0 0 4px; }
    .btn-group .filter-btn:last-child  { border-radius: 0 4px 4px 0; border-right-width: 1px; }

    /* ── Settings popover ── */
    .settings-btn-wrap { position: relative; }
    .settings-popover {
      position: absolute; top: calc(100% + 8px); right: 0;
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 6px; padding: 10px 14px; min-width: 220px;
      z-index: 200; box-shadow: 0 6px 24px rgba(0,0,0,.6);
    }
    .settings-row { display: flex; align-items: center; gap: 6px; padding: 4px 0; }

    /* ── Orders table ── */
    .table-wrap { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      padding: 10px 14px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text2);
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    thead th.r { text-align: right; }
    thead th:hover { color: var(--text); }
    thead th.th-sorted { color: var(--gold); }
    tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--bg3); }
    td { padding: 9px 14px; white-space: nowrap; vertical-align: middle; }
    td.r { text-align: right; }

    .item-cell { display: flex; align-items: center; gap: 10px; }
    .item-icon { width: 32px; height: 32px; border-radius: 3px; background: var(--bg3); flex-shrink: 0; }
    .item-name { font-weight: 500; color: var(--text); text-decoration: none; }
    .item-name:hover { color: var(--blue); text-decoration: underline; }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .badge-sell     { background: rgba(61,186,110,.18); color: var(--green);  border: 1px solid rgba(61,186,110,.4); }
    .badge-buy      { background: rgba(74,158,237,.18); color: var(--blue);   border: 1px solid rgba(74,158,237,.4); }
    .badge-corp     { background: rgba(155,111,212,.15); color: var(--purple); border: 1px solid rgba(155,111,212,.35); margin-left: 5px; font-size: 10px; }
    .badge-personal { background: rgba(198,162,39,.12); color: var(--gold);   border: 1px solid rgba(198,162,39,.3);  margin-left: 5px; font-size: 10px; }

    .price { color: var(--gold); font-weight: 600; font-variant-numeric: tabular-nums; }
    .total { color: var(--text); font-weight: 600; font-variant-numeric: tabular-nums; }

    .qty-cell  { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }
    .vol-track { width: 48px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; flex-shrink: 0; }
    .vol-fill  { height: 100%; background: var(--blue); border-radius: 2px; }
    .vol-text  { font-size: 12px; color: var(--text2); font-variant-numeric: tabular-nums; }

    .loc-cell { color: var(--text2); max-width: 200px; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .loc-cell:hover { color: var(--blue); text-decoration: underline; }
    .expiry-ok   { color: var(--text2); }
    .expiry-warn { color: var(--orange); }
    .expiry-crit { color: var(--red); }
    .copy-btn    { background: transparent; border: 1px solid var(--border); border-radius: 4px;
                   color: var(--text2); font-size: 14px; cursor: pointer; padding: 1px 5px;
                   line-height: 1.4; transition: color .15s, border-color .15s; }
    .copy-btn:hover  { color: var(--gold); border-color: var(--gold); }
    .copy-btn-ok     { color: var(--green) !important; border-color: var(--green) !important; }
    .copy-btn-warn   { color: var(--gold)  !important; border-color: var(--gold)  !important; }

    /* ── Compact mode ── */
    .btn-active { background: var(--bg3) !important; color: var(--text) !important; border-color: var(--text2) !important; }
    #orders-table.compact thead th { padding: 5px 14px; }
    #orders-table.compact td       { padding: 3px 14px; }
    #orders-table.compact .item-icon { display: none; }
    #orders-table.compact .item-cell { gap: 6px; }

    /* ── Undercut settings bar ── */
    .settings-bar {
      display: flex; align-items: center; gap: 6px;
      margin-bottom: 10px; flex-wrap: wrap;
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 6px; padding: 6px 12px;
    }
    .settings-label {
      color: var(--text2); font-size: 11px;
      text-transform: uppercase; letter-spacing: 0.6px; font-weight: 700;
      padding: 0 2px; white-space: nowrap;
    }
    /* ── Undercut status ── */
    .uc-best    { color: var(--green);  font-size: 12px; font-weight: 700; white-space: nowrap; }
    .uc-cut     { color: var(--red);    font-size: 12px; font-weight: 700; white-space: nowrap; }
    .uc-loading { color: var(--text2);  font-size: 12px; }
    .uc-diff    { font-weight: 400; color: var(--red); font-size: 11px; display: block; }
    .mini-spin  {
      display: inline-block; width: 10px; height: 10px;
      border: 2px solid var(--border); border-top-color: var(--text2);
      border-radius: 50%; animation: spin .8s linear infinite; vertical-align: middle;
    }

    /* ── Location chip (active station filter) ── */
    .loc-chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(74,158,237,.15); color: var(--blue);
      border: 1px solid rgba(74,158,237,.4); border-radius: 4px;
      padding: 4px 10px; font-size: 12px; font-weight: 600;
    }
    .loc-chip-x {
      cursor: pointer; font-size: 14px; line-height: 1;
      color: var(--text2); background: none; border: none; padding: 0;
    }
    .loc-chip-x:hover { color: var(--red); }

    /* ── Active station row ── */
    .station-table tr.st-active td { background: rgba(74,158,237,.08); color: var(--blue); }
    .station-table tr.st-active td.st-sell { color: var(--blue); }
    .station-table tr.st-active td.st-buy  { color: var(--blue); }
    .station-table tr.st-active td.price   { color: var(--blue); }
    .station-table tr { cursor: pointer; }

    /* ── State messages ── */
    .state-msg { padding: 60px 20px; text-align: center; color: var(--text2); }
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin .8s linear infinite;
      margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .err-text { color: var(--red); margin-top: 8px; font-size: 13px; }
    .warn-note { color: var(--orange); font-size: 12px; margin-top: 6px; }

    /* ── Responsive ── */
    @media (max-width: 640px) {
      .login-card { padding: 24px; }
      #dashboard-view { padding: 12px; }
      .stat-card { min-width: 100px; }
      .stat-card.stat-wide { min-width: 150px; }
    }

    /* ── Account switcher dropdown ── */
    .acct-switcher { position: relative; display: flex; align-items: center; gap: 8px; }
    .acct-chevron  { font-size: 11px; padding: 4px 8px !important; line-height: 1; }
    .acct-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      min-width: 210px;
      z-index: 200;
      box-shadow: 0 6px 24px rgba(0,0,0,.6);
      overflow: hidden;
    }
    .acct-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background .1s;
    }
    .acct-item:hover    { background: var(--bg3); }
    .acct-item-active   { background: rgba(74,158,237,.08); cursor: default; }
    .acct-item img      { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border); flex-shrink: 0; }
    .acct-item-label    { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .acct-active-badge  { font-size: 10px; color: var(--green); font-weight: 700; flex-shrink: 0; }
    .acct-remove {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text2);
      font-size: 17px;
      line-height: 1;
      padding: 0 3px;
      cursor: pointer;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .acct-remove:hover  { color: var(--red); background: rgba(209,64,64,.12); }
    .acct-divider       { height: 1px; background: var(--border); }
    .acct-add {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 9px 12px;
      font-size: 13px;
      color: var(--blue);
      cursor: pointer;
      transition: background .1s;
    }
    .acct-add:hover { background: var(--bg3); }

    /* ── Header wallets ── */
    #header-wallets {
      display: flex;
      gap: 24px;
      align-items: center;
      flex: 1;
      justify-content: center;
    }
    .hw-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1px;
    }
    .hw-label {
      font-size: 10px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .hw-val {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.2;
      white-space: nowrap;
    }
    .hw-div-select {
      background: transparent;
      border: none;
      color: var(--text2);
      font-size: 10px;
      font-family: inherit;
      cursor: pointer;
      padding: 0;
    }
    .hw-div-select:hover { color: var(--text); }
    .wallet-value {
      font-size: 18px;
      font-weight: 700;
      white-space: nowrap;
    }
    .wallet-div-select {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text1);
      font-size: 11px;
      border-radius: 4px;
      padding: 1px 4px;
      cursor: pointer;
    }

    /* ── Help button ── */
    .help-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      font-size: 14px;
      font-weight: 700;
      border-radius: 50%;
    }

    /* ── Help modal ── */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .help-modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 100%;
      max-width: 680px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .help-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .help-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gold);
    }
    .help-body {
      padding: 18px 22px;
      overflow-y: auto;
      font-size: 13.5px;
      line-height: 1.65;
      color: var(--text1);
    }
    .help-body h3 {
      margin: 18px 0 6px;
      font-size: 14px;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .help-body h3:first-child { margin-top: 0; }
    .help-body p  { margin: 0 0 8px; }
    .help-body ul { margin: 0 0 8px; padding-left: 20px; }
    .help-body li { margin-bottom: 4px; }
    .help-body strong { color: var(--text1); }
  </style>
</head>
<body>

<header>
  <div class="logo"><span class="eve">EVE</span>&nbsp;<span class="orders">Orders</span></div>
  <div id="header-wallets"></div>
  <div style="display:flex;align-items:center;gap:10px">
    <button class="btn btn-secondary help-btn" onclick="toggleHelp()" title="Open user guide">?</button>
    <div id="header-right"></div>
  </div>
</header>

<main>

  <!-- ── Login View ── -->
  <div id="login-view">
    <div class="login-card">
      <h2>EVE Orders Dashboard</h2>
      <p>Monitor your character and corporation market orders. Sign in with your EVE Online account to get started.</p>

<div id="login-error"></div>

      <button class="btn btn-primary" id="login-btn" style="width:100%;padding:12px 0;" onclick="startLogin()">
        Sign In with EVE Online
      </button>
    </div>
  </div>

  <!-- ── Dashboard View ── -->
  <div id="dashboard-view" style="display:none">

    <!-- Stats -->
    <div class="stats-bar" id="stats-bar">
      <div class="stat-card"><div class="stat-label">Orders</div><div class="stat-value">—</div></div>
    </div>

    <!-- Station Breakdown -->
    <div class="section" id="station-section">
      <div class="section-header" onclick="toggleSection()">
        <span class="section-title">Station Breakdown</span>
        <span class="section-toggle" id="section-toggle-icon">▲ hide</span>
      </div>
      <div id="station-breakdown-body"></div>
    </div>

    <!-- Orders toolbar -->
    <div class="toolbar">
      <span class="toolbar-title">Market Orders</span>
      <div class="filter-group">
        <select id="type-filter" onchange="setTypeFilter(this.value)" title="Filter by sell or buy orders">
          <option value="all">All Types</option>
          <option value="sell">Sell</option>
          <option value="buy">Buy</option>
        </select>
        <select id="src-filter" onchange="setSrcFilter(this.value)" title="Filter by personal or corporation orders">
          <option value="all">All Sources</option>
          <option value="personal">Personal</option>
          <option value="corp">Corp</option>
        </select>
        <select id="uc-filter" onchange="setUcFilter(this.value)" title="Filter by undercut status. Dupes = multiple orders for the same item at the same station.">
          <option value="all">All Status</option>
          <option value="best">Best Price</option>
          <option value="undercut">Undercut</option>
          <option value="dupes">Dupes</option>
        </select>
        <div id="loc-chip-wrap"></div>
        <button class="btn btn-secondary" onclick="resetFilters()" title="Clear all active filters">Reset</button>
      </div>
      <div class="settings-btn-wrap">
        <button class="btn btn-secondary" id="settings-btn" onclick="toggleSettings(event)" title="Settings, refresh and display options">⚙</button>
        <div class="settings-popover" id="settings-popover" style="display:none" onclick="event.stopPropagation()">
          <div class="settings-row">
            <span class="settings-label" title="Station: compare only against orders at the same station. Region: compare against the best price anywhere in the region.">Scope</span>
            <button class="filter-btn" data-us="station" onclick="setUcScope('station',this)" title="Undercut check vs orders at the same station only">Station</button>
            <button class="filter-btn" data-us="region"  onclick="setUcScope('region',this)"  title="Undercut check vs best price in the entire region">Region</button>
          </div>
          <div class="settings-row">
            <span class="settings-label" title="Number of 0.01 ISK ticks to move below the current best price when suggesting an undercut price.">Ticks</span>
            <input type="number" id="uc-ticks-input" class="ticks-input" min="1" step="1" value="1" onchange="setUcTicks(+this.value)" title="How many price ticks (0.01 ISK each) to undercut by">
          </div>
          <div class="settings-row" style="margin-top:4px">
            <span class="settings-label" id="uc-timestamp">Market checked: —</span>
          </div>
          <div class="acct-divider" style="margin:6px 0"></div>
          <div class="settings-row">
            <button class="btn btn-secondary" id="compact-btn" onclick="toggleCompact()" style="flex:1" title="Toggle compact view — hides item icons and reduces row height">Compact</button>
            <button class="btn btn-secondary" id="refresh-btn" onclick="loadOrders()"    style="flex:1" title="Reload all orders and re-check market prices">Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders table -->
    <div class="table-wrap">
      <div class="state-msg" id="table-msg">
        <div class="spinner"></div>
        Loading orders…
      </div>
      <table id="orders-table" style="display:none">
        <thead>
          <tr>
            <th class="copy-col" title="Copy suggested undercut price to clipboard and open in-game market window"></th>
            <th onclick="sortBy('item')"     title="Click to sort by item name">         Item       <span id="si-item"></span></th>
            <th onclick="sortBy('type')"     title="Click to sort by order type">        Type       <span id="si-type"></span></th>
            <th onclick="sortBy('status')"   title="Click to sort by undercut status">   Status     <span id="si-status"></span></th>
            <th onclick="sortBy('price')"  class="r" title="Click to sort by unit price">Unit Price  <span id="si-price"></span></th>
            <th onclick="sortBy('volume')" class="r" title="Click to sort by remaining quantity">Qty         <span id="si-volume"></span></th>
            <th onclick="sortBy('total')"  class="r" title="Click to sort by total order value (price × qty)">Order Total <span id="si-total"></span></th>
            <th onclick="sortBy('location')" title="Click to sort by station name">      Location   <span id="si-location"></span></th>
            <th onclick="sortBy('expiry')"   title="Click to sort by expiry date">       Expires     <span id="si-expiry"></span></th>
          </tr>
        </thead>
        <tbody id="orders-body"></tbody>
      </table>
    </div>

  </div>

</main>

<!-- ── Help Modal ── -->
<div id="help-overlay" class="help-overlay" style="display:none" onclick="closeHelp(event)">
  <div class="help-modal" onclick="event.stopPropagation()">
    <div class="help-header">
      <span class="help-title">EVE Orders — User Guide</span>
      <button class="btn btn-secondary" onclick="toggleHelp()" style="padding:2px 10px;font-size:16px">✕</button>
    </div>
    <div class="help-body">

      <h3>Getting Started</h3>
      <p>Click <strong>Sign In with EVE Online</strong> to authenticate using your EVE SSO account. Your tokens are stored locally in your browser and are never sent anywhere except the official EVE SSO and ESI servers. To add more characters, open the account switcher in the top-right and choose <em>Add Account</em>.</p>

      <h3>Dashboard Overview</h3>
      <p>Once logged in you will see three sections:</p>
      <ul>
        <li><strong>Wallet Bar</strong> — Your personal and corp ISK balances. Use the division selector on the corp wallet to pick which wallet to display.</li>
        <li><strong>Stats Bar</strong> — At-a-glance numbers: free order slots, undercut status (always visible), corp order counts (if you have the role), sell/buy values, and top items. Hover any card for a description.</li>
        <li><strong>Station Breakdown</strong> — Your orders grouped by station with sell/buy counts and undercut flags. Click the header to collapse.</li>
        <li><strong>Market Orders Table</strong> — Every active order with full detail. Click any station row above to filter the table to that station.</li>
      </ul>

      <h3>Filters</h3>
      <ul>
        <li><strong>All Types / Sell / Buy</strong> — Show only sell orders, only buy orders, or both.</li>
        <li><strong>All Sources / Personal / Corp</strong> — Switch between your personal orders and corp orders. Corp requires the Accountant or Market Manager role in your corporation.</li>
        <li><strong>All Status / Best Price / Undercut / Dupes</strong> — Filter by undercut status. <em>Dupes</em> shows items where you have more than one order at the same station.</li>
        <li><strong>Location chip</strong> — Appears when you click a station in the Station Breakdown. Shows orders only at that station. Click the ✕ on the chip to clear.</li>
        <li><strong>Reset</strong> — Clears all active filters at once.</li>
      </ul>

      <h3>Undercut Detection</h3>
      <p>After orders load, the app fetches live market data in the background and flags any order where a competitor has a better price.</p>
      <ul>
        <li><strong>Station scope</strong> — Compares only against orders at the exact same station. Best for station traders.</li>
        <li><strong>Region scope</strong> — Compares against the best price anywhere in the region. Best for regional traders.</li>
        <li><strong>Ticks</strong> — EVE prices move in 0.01 ISK increments called ticks. Set how many ticks below the current best price the copy button will suggest. Default is 2 ticks.</li>
      </ul>

      <h3>Copy Button (⎘)</h3>
      <p>Clicking the copy icon on any order does two things simultaneously: copies the suggested undercut price to your clipboard, and opens the item's market window inside the EVE client (if the client is running). Paste the price directly into the <em>Modify Order</em> dialog.</p>

      <h3>Order Slots</h3>
      <p>The <strong>Personal Slots Free</strong> card shows how many more orders you can place, based on your Trade-related skills (Trade, Retail, Wholesale, Tycoon). The bar turns orange above 70% and red above 90% usage. Corp orders you placed yourself also consume your personal slots.</p>

      <h3>Corp Orders</h3>
      <p>Corp orders are visible if your character holds the <strong>Accountant</strong> or <strong>Market Manager</strong> role within the corporation. Without this role the corp section is hidden and a notice is shown. Orders placed by other corp members are included but they do not count against your personal slot limit.</p>

      <h3>Wallet</h3>
      <p>Personal and corp wallets are shown in the wallet bar below the stats. The corp wallet shows up to 7 divisions — use the division selector to switch between them. Division names are fetched from ESI when available.</p>

      <h3>Multi-Account</h3>
      <p>You can sign in with multiple EVE characters. Use the account switcher in the header to switch the active character or remove an account. Each character's tokens are stored independently.</p>

      <h3>Settings (⚙)</h3>
      <p>The settings button in the toolbar opens a popover with:</p>
      <ul>
        <li><strong>Scope</strong> — Station or Region undercut comparison.</li>
        <li><strong>Ticks</strong> — Price undercut increment.</li>
        <li><strong>Compact</strong> — Hides item icons and reduces row height for a denser view.</li>
        <li><strong>Refresh</strong> — Manually reload all orders and re-check market prices.</li>
      </ul>

    </div>
  </div>
</div>

<script>
// =============================================================
// CONFIG — paste your EVE application Client ID below, OR
//          enter it in the text field on the login page.
// =============================================================
const HARDCODED_CLIENT_ID = 'a46cb3ebd7d843c7ac95f827a43f5e56';

// =============================================================
// Constants
// =============================================================
const SSO_BASE     = 'https://login.eveonline.com';
const ESI_BASE     = 'https://esi.evetech.net/latest';
const SCOPES       = [
  'esi-markets.read_character_orders.v1',
  'esi-markets.read_corporation_orders.v1',
  'esi-skills.read_skills.v1',
  'esi-ui.open_window.v1',
  'esi-wallet.read_character_wallet.v1',
  'esi-wallet.read_corporation_wallets.v1',
].join(' ');
const REDIRECT_URI = window.location.origin + window.location.pathname;

// Multi-account storage keys
const ACCOUNTS_KEY  = 'eve_accounts';   // JSON: { charId: { at, rt, exp, cname, corpId } }
const ACTIVE_KEY    = 'eve_active_char'; // charId of the currently active account
const CLIENT_ID_KEY = 'eve_client_id';
const PKCE_V_KEY    = 'eve_pkce_v';
const PKCE_S_KEY    = 'eve_pkce_s';

// =============================================================
// App state
// =============================================================
let allOrders      = [];
let typeNames      = {};
let locNames       = {};
let activeTypeFilt = 'all';   // all | sell | buy
let activeSrcFilt  = 'all';   // all | personal | corp
let sortCol        = 'expiry';
let sortDir        = 1;
let sectionVisible = true;
let charSlotsUsed  = 0;        // orders placed by this character (personal + corp they placed)
let charSlotsMax   = 0;        // calculated from trade skills (0 = scope not granted)
let activeLocFilt  = null;     // location_id (number) or null for all stations
let activeUcFilt       = 'all';   // all | best | undercut
let undercutStatus     = {};       // order_id → { status: 'loading'|'best'|'undercut'|'error', diff: 0, bestCompetitor: null }
let marketCache        = {};       // 'regionId:typeId' → { ourOrders, market }
let undercutLastFetched = null;    // Date of last completed undercut check

let undercutTicks = parseInt(localStorage.getItem('eve_uc_ticks') || '1');  // ticks to move when undercutting
let undercutScope = localStorage.getItem('eve_uc_scope') || 'station';       // 'station' | 'region'
let compactMode   = localStorage.getItem('eve_compact') === '1';

let hasCorpRoles       = null;   // null=unknown, true=has roles, false=lacks Accountant/Market Manager
let walletPersonal     = null;   // personal ISK balance or null
let walletCorp         = null;   // array of {division, balance} or null
let walletCorpDivision = parseInt(localStorage.getItem('eve_corp_wallet_div') || '1');
let walletCorpNames    = {};     // division number → label (fetched if possible)

// =============================================================
// Multi-account helpers
// =============================================================
function getAccounts() {
  try { return JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '{}'); }
  catch (_) { return {}; }
}

function saveAccounts(obj) {
  localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(obj));
}

function getActiveCharId() {
  return localStorage.getItem(ACTIVE_KEY);
}

function setActiveAccount(charId) {
  localStorage.setItem(ACTIVE_KEY, charId);
  renderHeaderChar();
  loadOrders();
}

function removeAccount(charId) {
  const accounts = getAccounts();
  delete accounts[charId];
  saveAccounts(accounts);

  const remaining = Object.keys(accounts);
  if (!remaining.length) {
    localStorage.removeItem(ACTIVE_KEY);
    window.location.reload();
    return;
  }
  // If removing active account, switch to first remaining
  const currentActive = getActiveCharId();
  const nextId = currentActive === charId ? remaining[0] : currentActive;
  localStorage.setItem(ACTIVE_KEY, nextId);
  renderHeaderChar();
  loadOrders();
}

// One-time migration: move old flat-key tokens into the accounts object
function migrateOldTokens() {
  const oldAt    = localStorage.getItem('eve_at');
  const oldCid   = localStorage.getItem('eve_cid');
  if (!oldAt || !oldCid) return;

  const accounts = getAccounts();
  if (!accounts[oldCid]) {
    accounts[oldCid] = {
      at:    oldAt,
      rt:    localStorage.getItem('eve_rt')  || '',
      exp:   parseInt(localStorage.getItem('eve_exp') || '0'),
      cname: localStorage.getItem('eve_cname') || 'Pilot',
    };
    saveAccounts(accounts);
    if (!getActiveCharId()) localStorage.setItem(ACTIVE_KEY, oldCid);
  }
  // Remove legacy flat keys
  ['eve_at','eve_rt','eve_exp','eve_cid','eve_cname','eve_corp_id'].forEach(k => localStorage.removeItem(k));
}

// =============================================================
// PKCE helpers
// =============================================================
function randomStr(len) {
  const arr = new Uint8Array(Math.ceil(len * 3 / 4));
  crypto.getRandomValues(arr);
  return btoa(String.fromCharCode(...arr))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '')
    .slice(0, len);
}

async function pkceChallenge(verifier) {
  const data   = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// =============================================================
// Login
// =============================================================
async function startLogin() {
  const clientId = getClientId();
  if (!clientId) {
    showLoginError('No Client ID configured. Set HARDCODED_CLIENT_ID in the source.');
    return;
  }
  localStorage.setItem(CLIENT_ID_KEY, clientId);
  hideLoginError();

  const verifier  = randomStr(64);
  const state     = randomStr(16);
  const challenge = await pkceChallenge(verifier);

  localStorage.setItem(PKCE_V_KEY, verifier);
  localStorage.setItem(PKCE_S_KEY, state);

  const params = new URLSearchParams({
    response_type:         'code',
    client_id:             clientId,
    redirect_uri:          REDIRECT_URI,
    scope:                 SCOPES,
    code_challenge:        challenge,
    code_challenge_method: 'S256',
    state,
  });

  window.location.href = `${SSO_BASE}/v2/oauth/authorize?${params}`;
}

// =============================================================
// OAuth callback
// =============================================================
async function handleCallback(code, state) {
  if (state !== localStorage.getItem(PKCE_S_KEY)) {
    throw new Error('State mismatch — possible CSRF. Please try logging in again.');
  }

  const verifier = localStorage.getItem(PKCE_V_KEY);
  const clientId = localStorage.getItem(CLIENT_ID_KEY);
  if (!verifier || !clientId) throw new Error('Missing PKCE data. Please try logging in again.');

  const resp = await fetch(`${SSO_BASE}/v2/oauth/token`, {
    method:  'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type:    'authorization_code',
      code,
      redirect_uri:  REDIRECT_URI,
      client_id:     clientId,
      code_verifier: verifier,
    }),
  });

  if (!resp.ok) {
    const body = await resp.text();
    throw new Error(`Token exchange failed (${resp.status}): ${body}`);
  }

  const tokens = await resp.json();
  storeTokens(tokens);
  localStorage.removeItem(PKCE_V_KEY);
  localStorage.removeItem(PKCE_S_KEY);
  window.history.replaceState({}, '', window.location.pathname);
}

// =============================================================
// Token management
// =============================================================
function storeTokens(tokens) {
  let charId, charName;
  try {
    const payload = JSON.parse(atob(tokens.access_token.split('.')[1]));
    charId   = payload.sub.replace('CHARACTER:EVE:', '');
    charName = payload.name;
  } catch (e) {
    console.warn('Could not parse JWT payload', e);
    return;
  }

  const accounts = getAccounts();
  accounts[charId] = {
    at:    tokens.access_token,
    rt:    tokens.refresh_token || (accounts[charId] && accounts[charId].rt) || '',
    exp:   Date.now() + (tokens.expires_in - 30) * 1000,
    cname: charName,
  };
  saveAccounts(accounts);
  localStorage.setItem(ACTIVE_KEY, charId);
}

async function getToken(charId) {
  const cid      = charId || getActiveCharId();
  const accounts = getAccounts();
  const acct     = accounts[cid];
  if (!acct) {
    throw Object.assign(new Error('Session expired.'), { charId: cid, isAuthError: true });
  }
  if (Date.now() < (acct.exp || 0)) return acct.at;
  return doRefreshToken(cid);
}

async function doRefreshToken(charId) {
  const accounts = getAccounts();
  const acct     = accounts[charId];
  const clientId = localStorage.getItem(CLIENT_ID_KEY) || HARDCODED_CLIENT_ID;
  if (!acct || !acct.rt || !clientId) {
    throw Object.assign(new Error('Session expired.'), { charId, isAuthError: true });
  }

  const resp = await fetch(`${SSO_BASE}/v2/oauth/token`, {
    method:  'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type:    'refresh_token',
      refresh_token: acct.rt,
      client_id:     clientId,
    }),
  });

  if (!resp.ok) {
    throw Object.assign(new Error('Session expired. Please log in again.'), { charId, isAuthError: true });
  }

  const tokens   = await resp.json();
  const refreshed = getAccounts();
  if (refreshed[charId]) {
    refreshed[charId] = {
      ...refreshed[charId],
      at:  tokens.access_token,
      rt:  tokens.refresh_token || refreshed[charId].rt,
      exp: Date.now() + (tokens.expires_in - 30) * 1000,
    };
    saveAccounts(refreshed);
  }
  return tokens.access_token;
}

function logout() {
  const charId = getActiveCharId();
  if (charId) removeAccount(charId);
  else window.location.reload();
}

// =============================================================
// ESI helpers
// =============================================================
async function esiGet(path, charId) {
  const token = await getToken(charId);
  const resp  = await fetch(`${ESI_BASE}${path}`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  if (!resp.ok) throw new Error(`ESI ${path} → ${resp.status} ${resp.statusText}`);
  return resp.json();
}

async function esiPost(path, charId) {
  const token = await getToken(charId);
  const resp  = await fetch(`${ESI_BASE}${path}`, {
    method:  'POST',
    headers: { Authorization: `Bearer ${token}` },
  });
  // 204 = success (no body); surface scope errors so caller can handle them
  if (!resp.ok) {
    const err = new Error(`ESI ${path} → ${resp.status} ${resp.statusText}`);
    err.status = resp.status;
    throw err;
  }
}

async function resolveNames(ids) {
  if (!ids.length) return {};
  const out = {};
  for (let i = 0; i < ids.length; i += 999) {
    const chunk = ids.slice(i, i + 999);
    try {
      const resp = await fetch(`${ESI_BASE}/universe/names/`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify(chunk),
      });
      if (resp.ok) {
        const data = await resp.json();
        data.forEach(n => { out[n.id] = n.name; });
      }
    } catch (_) { /* best-effort */ }
  }
  return out;
}

// =============================================================
// Load orders — personal + corp
// =============================================================
let corpOrdersWarning = '';

async function loadOrders() {
  showMsg('<div class="spinner"></div>Loading orders…');
  document.getElementById('station-breakdown-body').innerHTML = '';
  const btn = document.getElementById('refresh-btn');
  btn.disabled = true;
  corpOrdersWarning   = '';
  hasCorpRoles        = null;
  walletPersonal      = null;
  walletCorp          = null;
  undercutStatus      = {};
  marketCache         = {};
  undercutLastFetched = null;
  renderUcTimestamp();
  activeLocFilt  = null;
  activeUcFilt   = 'all';
  renderLocChip();
  document.querySelectorAll('[data-tf]').forEach(b => { b.className = 'filter-btn'; if (b.dataset.tf === 'all') b.classList.add('f-active'); });
  document.querySelectorAll('[data-sf]').forEach(b => { b.className = 'filter-btn'; if (b.dataset.sf === 'all') b.classList.add('f-active'); });
  document.querySelectorAll('[data-uf]').forEach(b => { b.className = 'filter-btn'; if (b.dataset.uf === 'all') b.classList.add('f-active'); });

  try {
    const charId = getActiveCharId();

    // ── Character personal orders ──────────────────────────────
    const charOrdersRaw = await esiGet(`/characters/${charId}/orders/`, charId);
    // Keep only orders placed for the character personally (not via corp role)
    const personalOrders = charOrdersRaw
      .filter(o => !o.is_corporation)
      .map(o => ({ ...o, _src: 'personal', is_buy_order: o.is_buy_order || false }));
    // charSlotsUsed will be finalized after corp orders are fetched (corp orders
    // placed by this character also consume personal order slots)

    // ── Character skills → order slot capacity ─────────────────
    // Trade:3443 +4/lvl  Retail:3444 +8/lvl  Wholesale:16596 +16/lvl  Tycoon:18580 +32/lvl
    charSlotsMax = 0;
    try {
      const skillData = await esiGet(`/characters/${charId}/skills/`, charId);
      const sm = {};
      skillData.skills.forEach(s => { sm[s.skill_id] = s.trained_skill_level; });
      charSlotsMax = 5
        + (sm[3443] || 0) *  4   // Trade
        + (sm[3444] || 0) *  8   // Retail
        + (sm[16596] || 0) * 16   // Wholesale
        + (sm[18580] || 0) * 32;  // Tycoon
    } catch (e) {
      console.warn('Could not fetch skills (scope missing?):', e.message);
    }

    // ── Corporation orders ─────────────────────────────────────
    let corpOrders = [];
    try {
      // Get corp ID from character info
      const charInfo = await esiGet(`/characters/${charId}/`, charId);
      const corpId   = charInfo.corporation_id;
      // Cache corpId in the account object
      const accts = getAccounts();
      if (accts[charId]) { accts[charId].corpId = corpId; saveAccounts(accts); }

      const corpRaw = await esiGet(`/corporations/${corpId}/orders/`, charId);
      corpOrders = corpRaw.map(o => ({
        ...o,
        _src:         'corp',
        is_buy_order: o.is_buy_order || false,
        // corp endpoint uses issued_by instead of is_corporation
        is_corporation: true,
      }));
      hasCorpRoles = true;

      // ── Corp wallet ──────────────────────────────────────────
      try {
        walletCorp = await esiGet(`/corporations/${corpId}/wallets/`, charId);
        // Try to fetch division names (requires no extra scope beyond corp wallet)
        try {
          const divs = await esiGet(`/corporations/${corpId}/divisions/`, charId);
          walletCorpNames = {};
          (divs.wallet || []).forEach(d => { walletCorpNames[d.division] = d.name; });
        } catch (_) { walletCorpNames = {}; }
      } catch (_) { walletCorp = null; }
    } catch (e) {
      if (e.message.includes('403')) {
        hasCorpRoles = false;
        corpOrdersWarning = 'Corp orders require the Accountant or Market Manager role — showing personal orders only.';
      } else {
        corpOrdersWarning = `Corp orders unavailable: ${e.message}`;
      }
    }

    // ── Personal wallet ────────────────────────────────────────
    try {
      walletPersonal = await esiGet(`/characters/${charId}/wallet/`, charId);
    } catch (_) { walletPersonal = null; }

    allOrders = [...personalOrders, ...corpOrders];

    // Corp orders issued by this character use their personal order slots too
    const corpOrdersByChar = corpOrders.filter(o => o.issued_by === +charId);
    charSlotsUsed = personalOrders.length + corpOrdersByChar.length;

    // ── Resolve names ──────────────────────────────────────────
    const typeIds    = [...new Set(allOrders.map(o => o.type_id))];
    typeNames        = await resolveNames(typeIds);

    const stationIds = [...new Set(
      allOrders.map(o => o.location_id).filter(id => id < 1_000_000_000_000)
    )];
    locNames = await resolveNames(stationIds);

    updateCorpVisibility();
    renderWalletBar();
    renderStats();
    renderStationBreakdown();
    renderOrders();
    // Kick off undercut checks in the background — re-renders when done
    loadUndercutStatus(allOrders);
  } catch (e) {
    if (e.isAuthError) {
      // Token invalid/expired — remove that account and switch to another (or show login)
      removeAccount(e.charId);
      btn.disabled = false;
      return;
    }
    showMsg(`<div class="err-text">⚠ ${escHtml(e.message)}</div>`);
    console.error(e);
  }

  btn.disabled = false;
}

// =============================================================
// Corp visibility — hide corp-related UI when roles are missing
// =============================================================
function updateCorpVisibility() {
  const srcSelect = document.getElementById('src-filter');
  if (!srcSelect) return;
  const corpOption = srcSelect.querySelector('option[value="corp"]');
  if (corpOption) corpOption.disabled = (hasCorpRoles === false);
  // If corp was the active filter but we have no roles, reset to all
  if (hasCorpRoles === false && activeSrcFilt === 'corp') {
    activeSrcFilt = 'all';
    srcSelect.value = 'all';
  }
}

// =============================================================
// Render: wallet bar
// =============================================================
function renderWalletBar() {
  const el = document.getElementById('header-wallets');
  if (!el) return;

  let html = '';

  if (walletPersonal !== null) {
    html += `
      <div class="hw-card" title="Personal wallet balance">
        <div class="hw-label">Personal</div>
        <div class="hw-val green">${fmtISK(walletPersonal)}</div>
      </div>`;
  }

  if (walletCorp !== null) {
    const divObj  = walletCorp.find(d => d.division === walletCorpDivision) || walletCorp[0];
    const balance = divObj ? divObj.balance : 0;
    const opts    = walletCorp.map(d => {
      const lbl = walletCorpNames[d.division] || (d.division === 1 ? 'Master' : `Div ${d.division}`);
      return `<option value="${d.division}" ${d.division === walletCorpDivision ? 'selected' : ''}>${lbl}</option>`;
    }).join('');

    html += `
      <div class="hw-card" title="Corp wallet balance — use selector to switch division">
        <div class="hw-label">Corp <select class="hw-div-select" onchange="setCorpWalletDiv(+this.value)" title="Choose division">${opts}</select></div>
        <div class="hw-val gold">${fmtISK(balance)}</div>
      </div>`;
  }

  if (!html && walletPersonal === null && walletCorp === null) {
    html = `<span style="font-size:12px;color:var(--orange)" title="Re-authorize to grant wallet scopes">⚠ wallet unavailable — <a href="#" onclick="logout();return false;" style="color:var(--blue)">re-auth</a></span>`;
  }

  el.innerHTML = html;
}

function setCorpWalletDiv(div) {
  walletCorpDivision = div;
  localStorage.setItem('eve_corp_wallet_div', String(div));
  renderWalletBar();
}

// =============================================================
// Render: stats bar
// =============================================================
function renderStats() {
  // Respect active location filter — all cards (except personal slots) react to it
  const isLoc    = activeLocFilt !== null;
  const fullLoc  = isLoc ? (locNames[activeLocFilt] || `Station ${activeLocFilt}`) : null;
  // Shorten "Jita IV - Moon 4 - Caldari Navy Assembly Plant" → "Jita IV"
  const shortLoc = fullLoc ? fullLoc.split(' - ')[0] : null;
  const l        = shortLoc ? ` — ${shortLoc}` : '';

  // Corp orders in scope
  const corpOrds = allOrders.filter(o => o._src === 'corp' && (!isLoc || o.location_id === activeLocFilt));
  const corpSell = corpOrds.filter(o => !o.is_buy_order);
  const corpBuy  = corpOrds.filter(o =>  o.is_buy_order);

  // All orders in scope (for sell/buy totals)
  const scopeAll = isLoc ? allOrders.filter(o => o.location_id === activeLocFilt) : allOrders;
  const sellVal  = scopeAll.filter(o => !o.is_buy_order).reduce((s, o) => s + o.price * o.volume_remain, 0);
  const buyVal   = scopeAll.filter(o =>  o.is_buy_order).reduce((s, o) => s + o.price * o.volume_remain, 0);

  // Most valuable item — all sell orders in scope, ranked by highest unit price
  const byItem = {};
  scopeAll.filter(o => !o.is_buy_order).forEach(o => { if (!byItem[o.type_id] || o.price > byItem[o.type_id]) byItem[o.type_id] = o.price; });
  const topItemEntry = Object.entries(byItem).sort((a, b) => b[1] - a[1])[0];
  const topItemName  = topItemEntry ? (typeNames[topItemEntry[0]] || `Type ${topItemEntry[0]}`) : '—';
  const topItemVal   = topItemEntry ? topItemEntry[1] : 0;

  // Most valuable single order — all orders in scope
  const topOrder    = scopeAll.reduce((best, o) =>
    (o.price * o.volume_remain) > (best ? best.price * best.volume_remain : 0) ? o : best, null);
  const topOrderName = topOrder ? (typeNames[topOrder.type_id] || `Type ${topOrder.type_id}`) : '—';
  const topOrderVal  = topOrder ? topOrder.price * topOrder.volume_remain : 0;
  const topOrderSub  = topOrder ? `${fmtNum(topOrder.volume_remain)} × ${fmtISK(topOrder.price)}` : '';

  // Personal slots — never location-filtered, always character-level
  const slotsRemain = charSlotsMax > 0 ? charSlotsMax - charSlotsUsed : null;
  const slotsPct    = charSlotsMax > 0 ? Math.min(100, Math.round((charSlotsUsed / charSlotsMax) * 100)) : 0;
  const slotFill    = slotsPct >= 90 ? 'crit' : slotsPct >= 70 ? 'warn' : '';
  const slotsHtml   = charSlotsMax > 0
    ? `<div class="stat-value ${slotsRemain <= 5 ? 'red' : slotsRemain <= 20 ? 'gold' : 'green'}">${slotsRemain}</div>
       <div class="stat-sub">${charSlotsUsed} / ${charSlotsMax} used</div>
       <div class="slot-bar"><div class="slot-fill ${slotFill}" style="width:${slotsPct}%"></div></div>`
    : `<div class="stat-value" style="font-size:15px;color:var(--text2)">${charSlotsUsed} used</div>
       <div class="stat-sub" style="color:var(--orange)">Add esi-skills scope to see max</div>`;

  // Undercut — all orders in scope (personal + corp)
  const ucTotal   = scopeAll.length;
  const ucCut     = scopeAll.filter(o => undercutStatus[o.order_id]?.status === 'undercut').length;
  const ucBest    = scopeAll.filter(o => undercutStatus[o.order_id]?.status === 'best').length;
  const ucPending = scopeAll.some(o => !undercutStatus[o.order_id] || undercutStatus[o.order_id].status === 'loading');
  const ucRedPct   = ucTotal > 0 ? Math.round((ucCut  / ucTotal) * 100) : 0;
  const ucGrnPct   = ucTotal > 0 ? Math.round((ucBest / ucTotal) * 100) : 0;
  const ucHtmlStat = ucPending
    ? `<div class="stat-value" style="font-size:15px;color:var(--text2)"><span class="mini-spin"></span> checking…</div>`
    : `<div class="stat-value ${ucCut > 0 ? 'red' : 'green'}">${ucCut} <span style="font-size:14px;font-weight:400;color:var(--text2)">/ ${ucTotal}</span></div>
       <div class="stat-sub">${ucBest} best · ${ucCut} undercut</div>
       <div class="slot-bar" style="display:flex">
         <div style="height:100%;width:${ucRedPct}%;background:var(--red);transition:width .3s"></div>
         <div style="height:100%;width:${ucGrnPct}%;background:var(--green);transition:width .3s"></div>
       </div>`;

  const warnHtml = corpOrdersWarning
    ? `<div class="stat-card" style="border-left:3px solid var(--orange);flex-basis:100%">
         <div class="stat-label">Notice</div>
         <div class="warn-note">${escHtml(corpOrdersWarning)}</div>
       </div>`
    : '';

  const showCorp = hasCorpRoles !== false;
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card" title="Order slots available to place new market orders. Based on your Trade skills.">
      <div class="stat-label">Personal Slots Free</div>
      ${slotsHtml}
    </div>
    ${showCorp ? `
    <div class="stat-card" title="Total active corp orders visible to your character.">
      <div class="stat-label">Corp Orders${l}</div>
      <div class="stat-value">${corpOrds.length}</div>
      <div class="stat-sub">${corpSell.length} sell · ${corpBuy.length} buy</div>
    </div>` : ''}
    <div class="stat-card" title="How many of your active orders have been undercut by a competitor. Red = undercut, green = all best price.">
      <div class="stat-label">Undercut${l}</div>
      ${ucHtmlStat}
    </div>
    <div class="stat-card" title="Total ISK value of all active sell orders (price × remaining quantity).">
      <div class="stat-label">Sell Value${l}</div>
      <div class="stat-value gold">${fmtISK(sellVal)}</div>
    </div>
    <div class="stat-card" title="Total ISK committed to active buy orders (price × remaining quantity).">
      <div class="stat-label">Buy Volume${l}</div>
      <div class="stat-value blue">${fmtISK(buyVal)}</div>
    </div>
    <div class="stat-card stat-wide" title="Your sell order with the highest unit price across all your orders.">
      <div class="stat-label">Most Valuable Item${l}</div>
      <div class="stat-value gold" style="font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(topItemName)}</div>
      <div class="stat-sub">${fmtISK(topItemVal)} / unit</div>
    </div>
    <div class="stat-card stat-wide" title="Your single order with the highest total value (price × remaining qty) across all your orders.">
      <div class="stat-label">Most Valuable Order${l}</div>
      <div class="stat-value gold" style="font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(topOrderName)}</div>
      <div class="stat-sub">${fmtISK(topOrderVal)} · ${topOrderSub}</div>
    </div>
    ${warnHtml}
  `;
}

// =============================================================
// Render: station breakdown
// =============================================================
function renderStationBreakdown() {
  // Group by location_id
  const ucDataReady = allOrders.length > 0 &&
    allOrders.every(o => undercutStatus[o.order_id] && undercutStatus[o.order_id].status !== 'loading');

  const stations = {};
  allOrders.forEach(o => {
    const loc = o.location_id;
    if (!stations[loc]) stations[loc] = { sell: 0, buy: 0, sellVal: 0, buyVal: 0, undercut: 0 };
    if (o.is_buy_order) {
      stations[loc].buy++;
      stations[loc].buyVal += o.price * o.volume_remain;
    } else {
      stations[loc].sell++;
      stations[loc].sellVal += o.price * o.volume_remain;
    }
    if (undercutStatus[o.order_id]?.status === 'undercut') stations[loc].undercut++;
  });

  // Sort stations by total sell value desc
  const sorted = Object.entries(stations).sort((a, b) => b[1].sellVal - a[1].sellVal);

  if (!sorted.length) {
    document.getElementById('station-breakdown-body').innerHTML =
      '<div style="padding:20px;color:var(--text2);font-size:13px">No station data.</div>';
    return;
  }

  const rows = sorted.map(([locId, s]) => {
    const name    = parseInt(locId) < 1_000_000_000_000
                      ? (locNames[locId] || `Station ${locId}`)
                      : 'Player Structure';
    const total   = s.sellVal + s.buyVal;
    const orders  = s.sell + s.buy;
    const active  = activeLocFilt === parseInt(locId) ? 'st-active' : '';
    const ucCell  = ucDataReady
      ? (s.undercut > 0
          ? `<span style="color:var(--red);font-weight:700">${s.undercut}</span> / ${orders}`
          : `<span style="color:var(--green);font-weight:700">0</span> / ${orders}`)
      : `<span class="uc-loading"><span class="mini-spin"></span></span>`;
    return `
      <tr class="${active}" onclick="setLocFilter(${locId})" title="Click to filter orders to this station">
        <td class="st-name">${escHtml(name)}</td>
        <td class="r">${orders}</td>
        <td class="r st-sell">${s.sell}</td>
        <td class="r st-buy">${s.buy}</td>
        <td class="r st-sell">${fmtISK(s.sellVal)}</td>
        <td class="r st-buy">${fmtISK(s.buyVal)}</td>
        <td class="r price">${fmtISK(total)}</td>
        <td class="r">${ucCell}</td>
      </tr>
    `;
  }).join('');

  document.getElementById('station-breakdown-body').innerHTML = `
    <table class="station-table">
      <thead>
        <tr>
          <th>Station</th>
          <th class="r">Orders</th>
          <th class="r">Sell</th>
          <th class="r">Buy</th>
          <th class="r">Sell Value</th>
          <th class="r">Buy Volume</th>
          <th class="r">Combined</th>
          <th class="r">Undercut</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function toggleSection() {
  sectionVisible = !sectionVisible;
  document.getElementById('station-breakdown-body').style.display = sectionVisible ? '' : 'none';
  document.getElementById('section-toggle-icon').textContent = sectionVisible ? '▲ hide' : '▼ show';
}

// =============================================================
// Render: orders table
// =============================================================
function renderOrders() {
  let orders = allOrders;

  // Type filter
  if (activeTypeFilt === 'sell') orders = orders.filter(o => !o.is_buy_order);
  if (activeTypeFilt === 'buy')  orders = orders.filter(o =>  o.is_buy_order);

  // Source filter
  if (activeSrcFilt === 'personal') orders = orders.filter(o => o._src === 'personal');
  if (activeSrcFilt === 'corp')     orders = orders.filter(o => o._src === 'corp');

  // Location filter
  if (activeLocFilt !== null) orders = orders.filter(o => o.location_id === activeLocFilt);

  // Undercut filter (only applies once status is loaded)
  if (activeUcFilt === 'best')     orders = orders.filter(o => undercutStatus[o.order_id]?.status === 'best');
  if (activeUcFilt === 'undercut') orders = orders.filter(o => undercutStatus[o.order_id]?.status === 'undercut');
  if (activeUcFilt === 'dupes') {
    const count = {};
    orders.forEach(o => { const k = `${o.type_id}:${o.location_id}`; count[k] = (count[k] || 0) + 1; });
    orders = orders.filter(o => count[`${o.type_id}:${o.location_id}`] > 1);
  }

  orders = doSort(orders);

  if (!orders.length) {
    showMsg('No orders match the current filters.');
    return;
  }

  const now  = Date.now();
  const rows = orders.map(o => {
    const name   = typeNames[o.type_id] || `Type ${o.type_id}`;
    const loc    = o.location_id < 1_000_000_000_000
                     ? (locNames[o.location_id] || `Station ${o.location_id}`)
                     : 'Player Structure';
    const isBuy  = o.is_buy_order;
    const orderTotal = o.price * o.volume_remain;

    const expiresMs   = new Date(o.issued).getTime() + o.duration * 86_400_000;
    const daysLeft    = Math.ceil((expiresMs - now) / 86_400_000);
    const expiryClass = daysLeft <= 1 ? 'expiry-crit' : daysLeft <= 3 ? 'expiry-warn' : 'expiry-ok';
    const expiryText  = daysLeft <= 0 ? 'Expiring' : daysLeft === 1 ? '1 day' : `${daysLeft} days`;

    const srcBadge = o._src === 'corp'
      ? '<span class="badge badge-corp">CORP</span>'
      : '<span class="badge badge-personal">ME</span>';

    // Undercut status cell
    const uc = undercutStatus[o.order_id];
    let ucHtml;
    if (!uc || uc.status === 'loading') {
      ucHtml = `<span class="uc-loading"><span class="mini-spin"></span></span>`;
    } else if (uc.status === 'best') {
      ucHtml = `<span class="uc-best">● BEST</span>`;
    } else if (uc.status === 'undercut') {
      const sign = isBuy ? '+' : '-';
      ucHtml = `<span class="uc-cut">▼ ${sign}${fmtISK(uc.diff)}</span>`;
    } else {
      ucHtml = `<span class="uc-loading">—</span>`;
    }

    const copyBtn = (uc && (uc.status === 'undercut' || uc.status === 'best'))
      ? `<button id="copy-btn-${o.order_id}" class="copy-btn"
             title="Copy suggested price &amp; open in-game market window"
             onclick="copyUndercut(${o.order_id}, ${o.is_buy_order}, ${o.price}, ${o.type_id})">⎘</button>`
      : '';

    return `
      <tr>
        <td class="copy-col">${copyBtn}</td>
        <td>
          <div class="item-cell">
            <img class="item-icon"
                 src="https://images.evetech.net/types/${o.type_id}/icon?size=32"
                 alt="" loading="lazy">
            <a class="item-name" href="https://evetycoon.com/market/${o.type_id}" target="_blank" rel="noopener noreferrer">${escHtml(name)}</a>${srcBadge}
          </div>
        </td>
        <td><span class="badge ${isBuy ? 'badge-buy' : 'badge-sell'}">${isBuy ? 'Buy' : 'Sell'}</span></td>
        <td>${ucHtml}</td>
        <td class="r price">${fmtISK(o.price)}</td>
        <td class="r">
          <span class="vol-text">${fmtNum(o.volume_remain)}<span style="color:var(--text2)"> / </span>${fmtNum(o.volume_total)}</span>
        </td>
        <td class="r total">${fmtISK(orderTotal)}</td>
        <td class="loc-cell" title="Click to filter to this station" onclick="setLocFilter(${o.location_id})">${escHtml(loc)}</td>
        <td class="${expiryClass}">${expiryText}</td>
      </tr>
    `;
  }).join('');

  document.getElementById('orders-body').innerHTML = rows;
  document.getElementById('table-msg').style.display    = 'none';
  document.getElementById('orders-table').style.display = 'table';
}

// =============================================================
// Sort
// =============================================================
function doSort(orders) {
  return [...orders].sort((a, b) => {
    let av, bv;
    switch (sortCol) {
      case 'item':     av = typeNames[a.type_id] || ''; bv = typeNames[b.type_id] || ''; break;
      case 'type':     av = a.is_buy_order ? 0 : 1;    bv = b.is_buy_order ? 0 : 1;    break;
      case 'status': {
        const val = s => (!s || s.status === 'loading' || s.status === 'error') ? -1
                       : s.status === 'best' ? 0 : s.diff;
        av = val(undercutStatus[a.order_id]); bv = val(undercutStatus[b.order_id]); break;
      }
      case 'price':    av = a.price;                   bv = b.price;                   break;
      case 'volume':   av = a.volume_remain;            bv = b.volume_remain;            break;
      case 'total':    av = a.price * a.volume_remain;  bv = b.price * b.volume_remain;  break;
      case 'location': av = locNames[a.location_id] || ''; bv = locNames[b.location_id] || ''; break;
      case 'expiry':
        av = new Date(a.issued).getTime() + a.duration * 86_400_000;
        bv = new Date(b.issued).getTime() + b.duration * 86_400_000;
        break;
      default: return 0;
    }
    if (av < bv) return -sortDir;
    if (av > bv) return  sortDir;
    return 0;
  });
}

function sortBy(col) {
  sortDir = sortCol === col ? -sortDir : 1;
  sortCol = col;

  const cols = ['item','type','status','price','volume','total','location','expiry'];
  cols.forEach(c => {
    const ind = document.getElementById(`si-${c}`);
    const th  = ind?.parentElement;
    if (ind) ind.textContent = c === sortCol ? (sortDir === 1 ? ' ▲' : ' ▼') : '';
    if (th)  th.classList.toggle('th-sorted', c === sortCol);
  });

  renderOrders();
}

// =============================================================
// Filters
// =============================================================
function setTypeFilter(filter) {
  activeTypeFilt = filter;
  renderOrders();
}

function setSrcFilter(filter) {
  activeSrcFilt = filter;
  renderOrders();
}

function setUcFilter(filter) {
  activeUcFilt = filter;
  renderOrders();
}

function toggleCompact() {
  compactMode = !compactMode;
  localStorage.setItem('eve_compact', compactMode ? '1' : '0');
  applyCompact();
}

function applyCompact() {
  const tbl = document.getElementById('orders-table');
  const btn = document.getElementById('compact-btn');
  if (tbl) tbl.classList.toggle('compact', compactMode);
  if (btn) btn.classList.toggle('btn-active', compactMode);
}

function resetFilters() {
  activeTypeFilt = 'all';
  activeSrcFilt  = 'all';
  activeUcFilt   = 'all';
  document.getElementById('type-filter').value = 'all';
  document.getElementById('src-filter').value  = 'all';
  document.getElementById('uc-filter').value   = 'all';
  renderOrders();
}

function toggleSettings(e) {
  e.stopPropagation();
  const p = document.getElementById('settings-popover');
  if (!p) return;
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

// =============================================================
// Location filter
// =============================================================
function setLocFilter(locId) {
  // Toggle: clicking the active station clears it
  activeLocFilt = (activeLocFilt === locId) ? null : locId;
  renderLocChip();
  renderStats();              // update all stat cards to reflect station
  renderStationBreakdown();   // refresh active highlight
  renderOrders();
}

function renderLocChip() {
  const wrap = document.getElementById('loc-chip-wrap');
  if (!wrap) return;
  if (activeLocFilt === null) {
    wrap.innerHTML = '';
    return;
  }
  const name = activeLocFilt < 1_000_000_000_000
    ? (locNames[activeLocFilt] || `Station ${activeLocFilt}`)
    : 'Player Structure';
  wrap.innerHTML = `
    <span class="loc-chip">
      ${escHtml(name)}
      <button class="loc-chip-x" onclick="setLocFilter(${activeLocFilt})" title="Clear location filter">×</button>
    </span>
  `;
}

// =============================================================
// Undercut status
// =============================================================
async function fetchAllMarketOrders(regionId, typeId) {
  const url = `${ESI_BASE}/markets/${regionId}/orders/?type_id=${typeId}&page=`;
  const resp1 = await fetch(url + '1');
  if (!resp1.ok) return [];
  const totalPages = Math.min(parseInt(resp1.headers.get('X-Pages') || '1'), 20);
  const first = await resp1.json();
  if (totalPages === 1) return first;
  const rest = await Promise.all(
    Array.from({ length: totalPages - 1 }, (_, i) =>
      fetch(url + (i + 2)).then(r => r.ok ? r.json() : [])
    )
  );
  return [first, ...rest].flat();
}

async function loadUndercutStatus(orders) {
  // Initialise all as loading
  orders.forEach(o => { undercutStatus[o.order_id] = { status: 'loading', diff: 0 }; });
  renderOrders();

  // Group by (region_id, type_id) so we fetch each market once
  const pairs = new Map();
  orders.forEach(o => {
    const key = `${o.region_id}:${o.type_id}`;
    if (!pairs.has(key)) pairs.set(key, []);
    pairs.get(key).push(o);
  });

  const ourIds = new Set(orders.map(o => o.order_id));

  await Promise.all([...pairs.entries()].map(async ([key, ourOrders]) => {
    const [regionId, typeId] = key.split(':');
    try {
      const market = await fetchAllMarketOrders(regionId, typeId);
      marketCache[key] = { ourOrders, market };
      applyUndercutForKey(key, ourIds);
    } catch (e) {
      console.warn(`Undercut fetch failed for ${key}:`, e.message);
      ourOrders.forEach(o => { undercutStatus[o.order_id] = { status: 'error', diff: 0 }; });
    }
  }));

  undercutLastFetched = new Date();
  renderUcTimestamp();
  renderStats();
  renderStationBreakdown();
  renderOrders();
}

function applyUndercutForKey(key, ourIds) {
  const cached = marketCache[key];
  if (!cached) return;
  const { ourOrders, market } = cached;

  if (undercutScope === 'station') {
    // Compare per-station: only undercut if a competitor at the SAME station beats you
    const byLoc = {};
    market.forEach(mo => {
      if (ourIds.has(mo.order_id)) return;
      const loc = mo.location_id;
      if (!byLoc[loc]) byLoc[loc] = { sell: [], buy: [] };
      if (mo.is_buy_order) byLoc[loc].buy.push(mo.price);
      else                 byLoc[loc].sell.push(mo.price);
    });
    ourOrders.forEach(o => {
      const comp = byLoc[o.location_id] || { sell: [], buy: [] };
      if (o.is_buy_order) {
        const best = comp.buy.length ? Math.max(...comp.buy) : -Infinity;
        undercutStatus[o.order_id] = best > o.price
          ? { status: 'undercut', diff: best - o.price, bestCompetitor: best }
          : { status: 'best',     diff: 0,              bestCompetitor: null };
      } else {
        const best = comp.sell.length ? Math.min(...comp.sell) : Infinity;
        undercutStatus[o.order_id] = best < o.price
          ? { status: 'undercut', diff: o.price - best, bestCompetitor: best }
          : { status: 'best',     diff: 0,              bestCompetitor: null };
      }
    });
  } else {
    // Region scope: undercut if anyone in the region beats you, regardless of station
    const otherSell = market.filter(mo => !mo.is_buy_order && !ourIds.has(mo.order_id)).map(mo => mo.price);
    const otherBuy  = market.filter(mo =>  mo.is_buy_order && !ourIds.has(mo.order_id)).map(mo => mo.price);
    const regionBestSell = otherSell.length ? Math.min(...otherSell) : Infinity;
    const regionBestBuy  = otherBuy.length  ? Math.max(...otherBuy)  : -Infinity;
    ourOrders.forEach(o => {
      if (o.is_buy_order) {
        undercutStatus[o.order_id] = regionBestBuy > o.price
          ? { status: 'undercut', diff: regionBestBuy - o.price, bestCompetitor: regionBestBuy }
          : { status: 'best',     diff: 0,                       bestCompetitor: null };
      } else {
        undercutStatus[o.order_id] = regionBestSell < o.price
          ? { status: 'undercut', diff: o.price - regionBestSell, bestCompetitor: regionBestSell }
          : { status: 'best',     diff: 0,                        bestCompetitor: null };
      }
    });
  }
}

function renderUcTimestamp() {
  const el = document.getElementById('uc-timestamp');
  if (!el) return;
  if (!undercutLastFetched) { el.textContent = 'Market checked: —'; return; }
  const t  = undercutLastFetched;
  const hh = String(t.getHours()).padStart(2, '0');
  const mm = String(t.getMinutes()).padStart(2, '0');
  const ss = String(t.getSeconds()).padStart(2, '0');
  el.textContent = `Market checked: ${hh}:${mm}:${ss}`;
}

function setUcScope(scope, btn) {
  undercutScope = scope;
  localStorage.setItem('eve_uc_scope', scope);
  document.querySelectorAll('[data-us]').forEach(b => {
    b.className = 'filter-btn';
    if (b === btn) b.classList.add('f-active');
  });
  // Recompute from cached market data — no re-fetch needed
  if (Object.keys(marketCache).length > 0) {
    const ourIds = new Set(allOrders.map(o => o.order_id));
    Object.keys(marketCache).forEach(key => applyUndercutForKey(key, ourIds));
    renderStats();
    renderStationBreakdown();
    renderOrders();
  }
}

function setUcTicks(ticks) {
  undercutTicks = Math.max(1, ticks || 1);
  localStorage.setItem('eve_uc_ticks', undercutTicks);
}

function initUcSettings() {
  document.querySelectorAll('[data-us]').forEach(b => {
    b.className = 'filter-btn';
    if (b.dataset.us === undercutScope) b.classList.add('f-active');
  });
  const ti = document.getElementById('uc-ticks-input');
  if (ti) ti.value = undercutTicks;
}

// =============================================================
// UI helpers
// =============================================================
function showMsg(html) {
  document.getElementById('table-msg').innerHTML    = html;
  document.getElementById('table-msg').style.display = 'block';
  document.getElementById('orders-table').style.display = 'none';
}

function showView(v) {
  document.getElementById('login-view').style.display     = v === 'login'     ? 'flex'  : 'none';
  document.getElementById('dashboard-view').style.display = v === 'dashboard' ? 'block' : 'none';
}

function renderHeaderChar() {
  const activeId = getActiveCharId();
  const accounts = getAccounts();
  const acct     = accounts[activeId];
  if (!acct) return;

  const name  = acct.cname || 'Pilot';
  const items = Object.entries(accounts).map(([cid, a]) => {
    const isActive = cid === activeId;
    const label    = escHtml(a.cname || 'Pilot');
    return `
      <div class="acct-item${isActive ? ' acct-item-active' : ''}"
           ${isActive ? '' : `onclick="event.stopPropagation();setActiveAccount('${escHtml(cid)}')" `}>
        <img src="https://images.evetech.net/characters/${escHtml(cid)}/portrait?size=32" alt="${label}">
        <span class="acct-item-label">${label}</span>
        ${isActive ? '<span class="acct-active-badge">ACTIVE</span>' : ''}
        <button class="acct-remove" title="Remove account"
                onclick="event.stopPropagation();removeAccount('${escHtml(cid)}')">×</button>
      </div>`;
  }).join('');

  document.getElementById('header-right').innerHTML = `
    <div class="acct-switcher" id="acct-switcher">
      <img src="https://images.evetech.net/characters/${escHtml(activeId)}/portrait?size=32"
           alt="${escHtml(name)}" style="width:36px;height:36px;border-radius:50%;border:2px solid var(--border);">
      <span class="char-name">${escHtml(name)}</span>
      <button class="btn btn-secondary acct-chevron" onclick="toggleAcctDropdown(event)">▼</button>
      <div class="acct-dropdown" id="acct-dropdown" style="display:none" onclick="event.stopPropagation()">
        ${items}
        <div class="acct-divider"></div>
        <div class="acct-add" onclick="startLogin()">＋ Add Account</div>
      </div>
    </div>
  `;
}

function toggleAcctDropdown(e) {
  e.stopPropagation();
  const dd = document.getElementById('acct-dropdown');
  if (!dd) return;
  dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  el.textContent   = msg;
  el.style.display = 'block';
}
function hideLoginError() {
  document.getElementById('login-error').style.display = 'none';
}

function getClientId() {
  return localStorage.getItem(CLIENT_ID_KEY) || HARDCODED_CLIENT_ID;
}

// EVE uses a 4-significant-figure price model — only the first four digits
// determine the "tick" size used to undercut/outbid.
// e.g. 14,750,000 → tick = 10,000  |  2,464 → tick = 1  |  999.5 → tick = 0.1
function calcUndercutPrice(price, ticks, isBuy) {
  if (!price || price <= 0 || !isFinite(price)) return null;
  const magnitude = Math.floor(Math.log10(price));
  const scale     = Math.pow(10, magnitude - 3);
  // Divide and floor, adding a tiny epsilon to defeat floating-point underflow
  // (e.g. 999.5 / 0.1 = 9994.999... → 9994 without epsilon, but should be 9995)
  const sig4      = Math.floor(price / scale + 1e-9);
  const adjusted  = isBuy ? sig4 + ticks : sig4 - ticks;
  // Multiply back and round to 2 dp (EVE's price precision)
  return Math.round(adjusted * scale * 100) / 100;
}

function copyUndercut(orderId, isBuy, ourPrice, typeId) {
  const uc = undercutStatus[orderId];
  if (!uc || uc.status === 'loading') return;

  const refPrice  = (uc.status === 'undercut' && uc.bestCompetitor != null)
    ? uc.bestCompetitor : ourPrice;
  const suggested = calcUndercutPrice(refPrice, undercutTicks, isBuy);
  if (suggested === null) return;

  const text = suggested.toFixed(2);

  // Copy price to clipboard
  navigator.clipboard.writeText(text).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  });

  // Show ✓ for ~15 seconds so you can see where you are in the list
  const btn = document.getElementById(`copy-btn-${orderId}`);
  if (btn) {
    btn.textContent = '✓';
    btn.classList.add('copy-btn-ok');
    setTimeout(() => {
      btn.textContent = '⎘';
      btn.classList.remove('copy-btn-ok');
    }, 15000);
  }

  // Open in-game market window (best-effort)
  openMarketWindow(typeId, orderId);
}

async function openMarketWindow(typeId, orderId) {
  try {
    await esiPost(`/ui/openwindow/marketdetails/?type_id=${typeId}`, getActiveCharId());
  } catch (err) {
    if (err.status === 403) {
      const btn = document.getElementById(`copy-btn-${orderId}`);
      if (btn) {
        btn.textContent = '!';
        btn.classList.remove('copy-btn-ok');
        btn.classList.add('copy-btn-warn');
        btn.title = 'Re-login required to enable in-game window (new scope needed)';
        setTimeout(() => {
          btn.textContent = '⎘';
          btn.classList.remove('copy-btn-warn');
          btn.title = 'Copy suggested price & open in-game market window';
        }, 15000);
      }
    }
    // Other errors (EVE client not running, etc.) — fail silently
  }
}

function fmtISK(v) {
  if (v >= 1e12) return (v / 1e12).toFixed(2) + ' T';
  if (v >= 1e9)  return (v / 1e9 ).toFixed(2) + ' B';
  if (v >= 1e6)  return (v / 1e6 ).toFixed(2) + ' M';
  if (v >= 1e3)  return (v / 1e3 ).toFixed(1) + ' K';
  return v.toLocaleString() + ' ISK';
}

function fmtNum(n) { return n.toLocaleString(); }

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// =============================================================
// Help modal
// =============================================================
function toggleHelp() {
  const el = document.getElementById('help-overlay');
  el.style.display = el.style.display === 'none' ? 'flex' : 'none';
}
function closeHelp(e) {
  // Close when clicking the backdrop
  if (e.target.id === 'help-overlay') toggleHelp();
}

// =============================================================
// Init
// =============================================================
async function init() {
  const cbEl = document.getElementById('callback-url-display');
  if (cbEl) cbEl.textContent = REDIRECT_URI;

  // Migrate any existing single-account tokens to the new multi-account format
  migrateOldTokens();

  const params = new URLSearchParams(window.location.search);
  const code   = params.get('code');
  const state  = params.get('state');
  const error  = params.get('error');

  if (error) {
    showView('login');
    showLoginError(`EVE SSO error: ${params.get('error_description') || error}`);
    window.history.replaceState({}, '', window.location.pathname);
    return;
  }

  if (code && state) {
    showView('login');
    showMsg('<div class="spinner"></div>Authenticating…');
    try {
      await handleCallback(code, state);
    } catch (e) {
      showView('login');
      showLoginError(e.message);
      return;
    }
  }

  const accounts = getAccounts();
  const activeId = getActiveCharId();

  if (Object.keys(accounts).length && activeId && accounts[activeId]) {
    showView('dashboard');
    renderHeaderChar();
    initUcSettings();
    applyCompact();
    loadOrders();
    // Close the account dropdown when clicking anywhere outside it
    document.addEventListener('click', () => {
      const dd = document.getElementById('acct-dropdown');
      if (dd) dd.style.display = 'none';
      const sp = document.getElementById('settings-popover');
      if (sp) sp.style.display = 'none';
    });
  } else {
    showView('login');
  }
}

init();
</script>

</body>
</html>
